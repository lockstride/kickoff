name: Sync Plugin Distribution

on:
  workflow_run:
    workflows: ['CI']
    types: [completed]
    branches: [main]
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    # Only run if CI succeeded (or if manually triggered)
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}

    steps:
      - name: Checkout source repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}
          # Prevent GITHUB_TOKEN credential helper from overriding our deploy token
          persist-credentials: false

      - name: Display trigger information
        run: |
          echo "=== Sync Trigger Information ==="
          echo "Event: ${{ github.event_name }}"
          echo "Source SHA: ${{ github.event.workflow_run.head_sha || github.sha }}"
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            echo "CI Workflow Conclusion: ${{ github.event.workflow_run.conclusion }}"
          fi
          echo ""

      - name: Clone distribution repository
        env:
          DEPLOY_TOKEN: ${{ secrets.PLUGIN_DIST_DEPLOY_TOKEN }}
        run: |
          echo "=== Cloning Distribution Repository ==="
          git clone --branch main https://x-access-token:${DEPLOY_TOKEN}@github.com/lockstride/kickoff-plugin.git dist-repo
          cd dist-repo
          echo "Current branch: $(git branch --show-current)"
          echo "Remote URL: $(git remote get-url origin | sed 's/x-access-token:[^@]*/x-access-token:***/')"
          echo "Latest commit: $(git log --oneline -1)"
          echo "Clone completed successfully"
          echo ""

      - name: Sync plugin contents
        run: |
          echo "=== Syncing Plugin Contents ==="
          echo "Source: plugin/"
          echo "Destination: dist-repo/"
          rsync -av --delete --exclude='.git' --filter='protect /README.md' plugin/ dist-repo/
          echo ""

      - name: Show sync diff
        working-directory: dist-repo
        run: |
          echo "=== Changes Detected ==="
          git status --short
          echo ""
          echo "=== Detailed Status ==="
          git status
          echo ""

      - name: Commit and push changes
        working-directory: dist-repo
        env:
          SOURCE_SHA: ${{ github.event.workflow_run.head_sha || github.sha }}
        run: |
          echo "=== Checking for Changes ==="
          if [ -z "$(git status --porcelain)" ]; then
            echo "✓ No changes to sync - distribution repo is already up to date"
            exit 0
          fi

          echo "✓ Changes detected, proceeding with commit"
          echo ""

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          SHORT_SHA=$(echo "$SOURCE_SHA" | cut -c1-7)
          COMMIT_MSG="Sync from lockstride/kickoff@$SHORT_SHA"

          echo "=== Committing Changes ==="
          echo "Commit message: $COMMIT_MSG"
          git add -A
          git commit -m "$COMMIT_MSG"
          echo ""

          echo "=== Pushing to Distribution Repository ==="
          echo "Pushing to: lockstride/kickoff-plugin"
          git push origin main
          echo "✓ Successfully pushed changes to lockstride/kickoff-plugin"
